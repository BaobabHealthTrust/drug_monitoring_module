<style type="text/css">
    td {
        padding: 10px !important;
    }
    select,
    textarea,
    input {
        width: 70% !important;
        float: left !important;
    }
    button {
        margin: 10px !important;
    }
</style>

<div class="container theme-showcase" role="main">

<div class="panel panel-default">
  <div class="panel-heading">
    <h3 class="panel-title">Edit Site</h3>
  </div>
  <div class="panel-body">

    <%= form_tag('/administration/save_site', :method => 'post', :enctype => 'multipart/form-data',
                 :id => 'site-form', :class => "form-horizontal", :autocomplete => "off",:role => "form", :novalidate=> "novalidate") do %>

        <div class="form-control-group">
          <table style="width: 100%;">
            <tr>
              <td align="right" style="width: 20%">
                <label class="control-label">Site Name:</label>&nbsp;&nbsp;&nbsp;
              </td>
              <td>
                <select id="sitename" name="sitename" class="form-control" placeholder="Region" required="" onchange="switchSite(this.value)" >
                  <option value="">[ - Select site - ]</option>

                  <% @sites.each do |site| %>

                      <option value="<%= site.name %>"><%= site.name %></option>

                  <% end %>
                  <input name="old_site" class="form-control" id="old_site" required="" value="" type="hidden" />
                </select>
              </td>
            </tr>
          </table>
        </div>
        <div class="form-control-group">
          <table style="width: 100%;">
            <tr>
              <td align="right" style="width: 20%">
                <label class="control-label">IP Address:</label>&nbsp;&nbsp;&nbsp;
              </td>
              <td>
                <input name="ip_address" class="form-control" placeholder="Site IP Address" id="ip_address" required="" value="" type="text" minlength=7 ipaddress=true />
              </td>
            </tr>
          </table>
        </div>
        <div class="form-control-group">
          <table style="width: 100%;">
            <tr>
              <td align="right" style="width: 20%">
                <label class="control-label">Port:</label>&nbsp;&nbsp;&nbsp;
              </td>
              <td>
                <input name="port" class="form-control" placeholder="Port" id="port" required="" value="" type="text" />
              </td>
            </tr>
          </table>
        </div>
        <div class="form-control-group">
          <table style="width: 100%;">
            <tr>
              <td align="right" style="width: 20%">
                <label class="control-label">Threshold:</label>&nbsp;&nbsp;&nbsp;
              </td>
              <td>
                <input type="text" id="threshold" name="threshold" value="" class="form-control" placeholder="Enter discrepancy threshold" required="" digits=true />
              </td>
            </tr>
          </table>
        </div>

        <div class="form-control-group">
          <table style="width: 100%;">
            <tr>
              <td align="right" style="width: 20%">
                <label class="control-label">Region:</label>&nbsp;&nbsp;&nbsp;
              </td>
              <td>
                <select id="region" name="region" class="form-control" placeholder="Region" required="" onchange="switchRegion(this.value)" >
                  <option value="">[ - Select site region in Malawi - ]</option>
                  <option value="Centre">Central Region</option>
                  <option value="North">Northern Region</option>
                  <option value="South">Southern Region</option>
                </select>
              </td>
            </tr>
          </table>
        </div>
        <div class="form-control-group">
          <table style="width: 100%;">
            <tr>
              <td align="right" style="width: 20%; vertical-align: top;">
                <label class="control-label">Site location:</label>&nbsp;&nbsp;&nbsp;
              </td>
              <td>
                <iframe id="map" style="border: 1px dotted #999; padding: 0px; text-align: center; width: 70%; overflow: hidden !important; height: 600px;" src="/map?region"></iframe>
                <input name="x" class="form-control" id="x" required="" value="" type="hidden" />
                <input name="y" class="form-control" id="y" required="" value="" type="hidden" />
              </td>
            </tr>
          </table>
        </div>

        <table style="width: 100%;">
          <tr>
            <td style="width: 20%;">
              <button type="button" class="btn btn-danger" style="font-size: 18px !important; float: left;" onclick="window.location = '/'">Cancel</button>
            </td>
            <td>
              <button type="submit" class="btn btn-success btn-large" style="font-size: 18px !important; float: right;">Save Site</button>
            </td>
          </tr>
        </table>

    <% end %>

  </div>
</div>
</div>

<script defer="true">
    var sites = {};

    <% @sites.each do |site| %>
        sites["<%= site.name %>"] = {"name": '<%= site.name %>', "ip_address": '<%= site.ip_address %>',
                                     "port": '<%= site.port %>', "x": '<%= site.x %>', "y":'<%= site.y %>' ,
                                    "threshold": <%= site.threshold %>,"region":'<%= site.region %>'}

    <% end %>



    jQuery.validator.addMethod("sitecode", function(value, element) {
        return this.optional(element) || /^[A-Z]{3}$/.test(value);
    }, "Please 3 capital letters only.");

    jQuery.validator.addMethod("ipaddress", function(value, element) {
        return this.optional(element) || /^\d+\.\d+\.\d+\.\d+$/.test(value);
    }, "Not a valid IP address.");

    function switchRegion(region){
        document.getElementById("map").setAttribute("src", "/map?region=" + region.toLowerCase().trim());
    }

    function switchSite(sitename){
        document.getElementById("sitename").value = sites[sitename]["name"];
        document.getElementById("old_site").value = sites[sitename]["name"];
        document.getElementById("ip_address").value = sites[sitename]["ip_address"];
        document.getElementById("port").value = sites[sitename]["port"];
        document.getElementById("map").setAttribute("src", "/map?region=" + sites[sitename]["region"] + "&x=" + sites[sitename]["x"] + "&y=" + sites[sitename]["y"]);
        document.getElementById("x").value = sites[sitename]["x"];
        document.getElementById("y").value = sites[sitename]["y"];
        document.getElementById("region").value = sites[sitename]["region"];
        document.getElementById("threshold").value = sites[sitename]["threshold"];
    }


    function prettyPrint(){
        $(document).ready(function(){

            $('#site-form').validate({
                rules: {},
                highlight: function(element) {
                    $(element).closest('.control-group').removeClass('success').addClass('error');
                },
                success: function(element) {
                    element
                            .text('OK!').addClass('valid')
                            .closest('.control-group').removeClass('error').addClass('success');
                }
            });

        }); // end document.ready
    }

    $(document).ready(function(){

        $('#site-form').validate({
            highlight: function(element) {
                $(element).closest('.control-group').removeClass('success').addClass('error');
            },
            success: function(element) {
                element
                        .text('OK!').addClass('valid')
                        .closest('.control-group').removeClass('error').addClass('success');
            }
        });

    }); // end document.ready

    addEventListener('load', prettyPrint, false);
    $(document).ready(function(){
        $('pre').addClass('prettyprint linenums');
    });
</script>