
<%= stylesheet_link_tag "bootstrap-tree/bootstrap-tree" %>                                         

<div class="container-fluid">
    <div class="row-fluid">
        <div class="span3">
            <div class="well">
              <ul class="tree">
                <%(@tree || {}).sort_by{|k , v| k }.each do |cat, values|%>
                  <li>
                    <%unless values.blank?%>
                      <a href="#" role="branch" class="tree-toggle closed" data-toggle="branch" data-value="Bootstrap_Tree"><%=cat%></a>
                    <%else%>
                      <li><a href="#" onclick="javascript:setSelectedValue('<%=cat%>');" class="tree-toggle" role="branch"><%=cat%></a></li>
                    <%end%>
                      <ul class="branch">
                        <%(values || {}).sort_by{|k , v| k }.each do |child_name, child_values|%>
                          <%unless child_values.blank?%>
                            <a href="#" role="branch" class="tree-toggle closed" data-toggle="branch" data-value="Bootstrap_Tree"><%=child_name%></a>
                          <%else%>
                            <li><a href="#" onclick="javascript:setSelectedValue('<%=child_name%>');" class="tree-toggle"><%=child_name%></a></li>
                          <%end%>
                          <%unless child_values.blank?%>
                            <ul class="branch">
                              <%(child_values || []).each do | c |%>
                                <li><a href="#" role="leaf" onclick="javascript:setSelectedValue('<%= c %>');"><%= c %></a></li>
                              <%end%>
                            </ul>
                          <%end%>
                        <%end%>
                <%end%>
              </ul>
              </ul>

            </div><!--/well-->
          </div><!--/span-->
          <div class="span9" id="mainContent">
              <div class="row-fluid">
                  <div class="well span13" id="editorArea">
                    <!-- content -->
                      <h3>Report:&nbsp;<%=params[:id]%></h3>
                      <br />  
                      <br />
                        <table style="width: 99%;">
                          <tr>
                            <td><label>Drug:</label></td>
                            <td><label id="selection-label" style="font-weight: bold;"></label></td>
                          </tr>
                          <tr>
                            <td>Select site</td>
                            <%sites = []
                              Site.all.map do |s|
                                sites << [s.name, s.id]
                              end
                            %>
                            <td>
                              <select id="sitename" name="sitename" class="form-control" placeholder="Region" required=""  >
                                <option value="">[ - Select site - ]</option>
                                  <% (sites || []).each do |site, id| %>
                                    <option value="<%= id%>"><%= site %></option>
                                  <% end %>
                              </select>
                            </td>
                          </tr>
                          <tr>
                            <td>Start date</td><td><input type="text" id="start_date" required="" /></td>
                          </tr>
                          <tr>
                            <td>End date</td><td><input type="text" id="end_date" required="" /></td>
                          </tr>
                          <tr>
                            <td colspan="2">
                              <input type="submit" class="btn btn-success" value="Submit" onclick="display_report()" style="width: 60%;" />
                            </td>
                          </tr>
                        </table>


                      <%#=yield%>
                    <!-- content ends -->
                  </div>
              </div>
              <div class="span8" id="reporter">test</div>
          </div>
    </div>
</div>

<%=javascript_include_tag "bootstrap-tree/jquery-1.8.2"%>
<%=javascript_include_tag "bootstrap-tree/bootstrap.min"%>
<%=javascript_include_tag "bootstrap-tree/bootstrap-tree"%>

<script>
function setSelectedValue(value) {
  label = document.getElementById('selection-label');
  label.innerHTML = value;
}
function display_report(){


    var site = document.getElementById('sitename').value
    var start_date = document.getElementById("start_date").value
    var end_date = document.getElementById('end_date').value
    var drug = document.getElementById('selection-label').innerHTML


    document.getElementById('reporter').innerHTML = "Please wait ....";

    if (window.XMLHttpRequest) {// code for IE7+, Firefox, Chrome, Opera, Safari
        xmlhttp=new XMLHttpRequest();
    }else{// code for IE6, IE5
        xmlhttp=new ActiveXObject("Microsoft.XMLHTTP");
    }
    xmlhttp.onreadystatechange=function() {
        if (xmlhttp.readyState==4 && xmlhttp.status==200) {
            var results = xmlhttp.responseText;
            if(results == 'undefined' || results == '' || results == '"not validate"') {
                document.getElementById('reporter').innerHTML = "....";
                return;
            }else if(results.length > 0){
                plotGraph();
                document.getElementById('reporter').innerHTML = results;
            }else{
                document.getElementById('reporter').innerHTML = "....";
                return;
            }
        }
    }
    xmlhttp.open("GET",'/report/stock_movement?site_id=' + site + "&start_date="+ start_date + "&end_date="+end_date + "&drug="+ drug ,true);
    xmlhttp.send();



    //jQuery('#reporter').empty().html("<span style='padding-left: 43.5%; width: 100%; text-align: center; font-size: 30px;'>Loading...</span>").load('/report/stock_movement?site_name=' + site + "&start_date="+ start_date + "&end_date="+end_date + "&drug="+ drug  );
}
</script>

<script type="text/javascript">

    function plotGraph(){
        $('#graph').innerHtml = "testing graph"
        $(function () {
            $('#graph').highcharts({
                chart: {
                    type: 'line'
                },
                title: {
                    text: ''
                },
                subtitle: {
                    text: ''
                },
                xAxis: {
                    /*categories:  getDates(), */
                    type: 'datetime',
                    dateTimeLabelFormats: {
                        day: '%e %b',
                        week: '%e %b'
                    }
                },
                yAxis: {

                    title: {
                        text: 'Tins in stock'
                    },
                    labels: {
                        formatter: function() {
                            return this.value;
                        }
                    }

                },
                tooltip: {
                    shared: true,
                    valueSuffix: ' Tins'
                },
                plotOptions: {
                    area: {
                        stacking: 'normal',
                        lineColor: '#666666',
                        lineWidth: 2,
                        marker: {
                            lineWidth: 100,
                            lineColor: '#666666'
                        }
                    }
                },
                series: [{name: 'Time', data: [1,2,5,3,48,92,48,2,5], negativeColor: 'red', pointInterval: 24 * 3600 * 1000}]
            });
        });
    }
</script>